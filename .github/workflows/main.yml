# File: .github/workflows/main.yml
name: Laravel CI (SQLite)

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main", "dev" ]
  workflow_dispatch:

jobs:
  laravel-ci:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # LANGKAH 2: Setup Lingkungan PHP
      - name: Setup PHP Environment
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4' 
          extensions: gd, mbstring, pdo_sqlite, bcmath 
          tools: composer

      # LANGKAH 3: Install Dependensi Composer
      - name: Install Composer Dependencies
        run: composer install --prefer-dist --no-progress --no-suggest
      
      # LANGKAH 4: Siapkan Environment Laravel
      - name: Prepare Laravel Environment
        run: |
          cp .env.example .env
          php artisan key:generate
          
      # LANGKAH 5: Setup Database SQLite & Migrasi/Seeder
      - name: Setup SQLite Database & Run Migrations
        run: |
          mkdir -p database 
          touch database/database.sqlite
          
          # Ubah koneksi ke SQLite di file .env
          sed -i 's/DB_CONNECTION=mysql/DB_CONNECTION=sqlite/' .env
          
          php artisan migrate --force --seed 
          
      # LANGKAH 6: Buat Storage Link (Perbaikan: Pastikan indentasi tepat!)
      - name: Create Storage Link for Uploads
        run: php artisan storage:link

      # LANGKAH 7 (Opsional): Jalankan PHPUnit Tests
      # - name: Run PHPUnit Tests
      #   run: vendor/bin/phpunit
